# Markdown File

кастомный синтаксис
утечка памяти
Debug
Использование сорсгенерации для отладкиизменение версии или базы данных и твой sql поплыл
Для решения вопроса по своим данным с кастомными выражениями можно использовать EF для генерации SQL. Таким образом можно избежать разбора выражений (позволить решать это вопрос Roslyn'у) и предоставить все остальное EF.



Инструменты преобразования бизнес выражений к SQL запросам


В докладе рассказывается о формирование SQL запросов из выражений в пользовательском синтаксисе. Т.е. описывается способ преобразования кастомной фильтрации в запросы к базе данных. Эту задачу можно решить использую возможности Roslyn для кодогенерации и EntityFramework Core для генерации запросов из полученных лямбда-выражений

Доклад расчитан на опытных разработчиков, которым интересны продвинутые сценарии использования EF и runtime кодогенерация. 

План

1. Описание проблемы: мы хотим предоставить пользователю возможность делать трансформацию и фильтрацию данных с помощью "произвольных" выражений 

2. Возможные подходы к решению:
a) самостоятельно разбирать выражения и на базе них формировать SQL
b) использовать готовый инструментарий для разбора выражений и формирование SQL

3. Предложенный подход:
a) по модели данных генерируется C# код сборки для работы с базой данных через Entity Framework.
b) C# код компилируется в сборку, сборка подгружается в процесс.
c) Выражения в бизнес синтаксисе преобразуются к лямбда-выражениям в EF контексте сгенерированной сборки.
d) Лямбда-выражения компилируются и средствами EF преобразуются к SQL запросам.

4. Проблемы
a) сложности при расширении возможностей EF
b) возможность неявной утечки памяти

Технологии
- Для динамической компиляции кода используется [Microsoft .NET Compiler Platform](https://docs.microsoft.com/dotnet/csharp/roslyn-sdk/).
- Для доступа к данным используется [EF Core](https://docs.microsoft.com/ef/core/) с провайдером доступа [PostgreSQL](http://www.npgsql.org/efcore/index.html).
- Для анализа и преобразования [Lambda выражений](https://docs.microsoft.com/dotnet/csharp/language-reference/operators/lambda-expressions) применяется паттерн [Visitor](https://docs.microsoft.com/dotnet/api/system.linq.expressions.expressionvisitor).
